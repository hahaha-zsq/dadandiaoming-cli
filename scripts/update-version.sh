#!/bin/bash

# ç‰ˆæœ¬æ›´æ–°è„šæœ¬
# ç”¨æ³•: ./scripts/update-version.sh [patch|minor|major]

set -e  # é‡åˆ°é”™è¯¯æ—¶é€€å‡º

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ‰“å°å¸¦é¢œè‰²çš„æ¶ˆæ¯
print_message() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}"
}

# æ˜¾ç¤ºä½¿ç”¨æ–¹æ³•
show_usage() {
    echo "ç”¨æ³•: $0 [ç‰ˆæœ¬ç±»å‹]"
    echo ""
    echo "ç‰ˆæœ¬ç±»å‹:"
    echo "  patch  - è¡¥ä¸ç‰ˆæœ¬ (1.0.0 -> 1.0.1) - ç”¨äºbugä¿®å¤"
    echo "  minor  - æ¬¡è¦ç‰ˆæœ¬ (1.0.0 -> 1.1.0) - ç”¨äºæ–°åŠŸèƒ½"
    echo "  major  - ä¸»è¦ç‰ˆæœ¬ (1.0.0 -> 2.0.0) - ç”¨äºé‡å¤§æ›´æ”¹"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  $0 patch"
    echo "  $0 minor"
    echo "  $0 major"
}

# æ£€æŸ¥å‚æ•°
if [ $# -eq 0 ] || [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    show_usage
    exit 0
fi

VERSION_TYPE=$1

# éªŒè¯ç‰ˆæœ¬ç±»å‹
if [[ ! "$VERSION_TYPE" =~ ^(patch|minor|major)$ ]]; then
    print_message $RED "âŒ é”™è¯¯: æ— æ•ˆçš„ç‰ˆæœ¬ç±»å‹ '$VERSION_TYPE'"
    show_usage
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦åœ¨gitä»“åº“ä¸­
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    print_message $RED "âŒ é”™è¯¯: å½“å‰ç›®å½•ä¸æ˜¯gitä»“åº“"
    exit 1
fi

# æ£€æŸ¥å·¥ä½œç›®å½•æ˜¯å¦å¹²å‡€
if [ -n "$(git status --porcelain)" ]; then
    print_message $YELLOW "âš ï¸  è­¦å‘Š: å·¥ä½œç›®å½•æœ‰æœªæäº¤çš„æ›´æ”¹"
    echo "æœªæäº¤çš„æ–‡ä»¶:"
    git status --porcelain
    echo ""
    read -p "æ˜¯å¦ç»§ç»­? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_message $YELLOW "ğŸ“¤ æ“ä½œå·²å–æ¶ˆ"
        exit 0
    fi
fi

# è·å–å½“å‰ç‰ˆæœ¬
CURRENT_VERSION=$(node -p "require('./package.json').version")
print_message $BLUE "ğŸ“¦ å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"

# æ›´æ–°ç‰ˆæœ¬
print_message $YELLOW "ğŸ”„ æ­£åœ¨æ›´æ–°ç‰ˆæœ¬..."
npm version $VERSION_TYPE --no-git-tag-version

# è·å–æ–°ç‰ˆæœ¬
NEW_VERSION=$(node -p "require('./package.json').version")
print_message $GREEN "âœ¨ æ–°ç‰ˆæœ¬: $NEW_VERSION"

# æäº¤æ›´æ”¹
print_message $YELLOW "ğŸ“ æ­£åœ¨æäº¤æ›´æ”¹..."
git add package.json

# æ£€æŸ¥æ˜¯å¦æœ‰package-lock.jsonå¹¶æ·»åŠ 
if [ -f "package-lock.json" ]; then
    git add package-lock.json
fi

git commit -m "chore: bump version to $NEW_VERSION"

# åˆ›å»ºæ ‡ç­¾
print_message $YELLOW "ğŸ·ï¸  æ­£åœ¨åˆ›å»ºæ ‡ç­¾..."
git tag "v$NEW_VERSION"

# æ¨é€æ›´æ”¹å’Œæ ‡ç­¾
print_message $YELLOW "ğŸ“¤ æ­£åœ¨æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
git push origin main || git push origin master
git push origin "v$NEW_VERSION"

print_message $GREEN "ğŸ‰ ç‰ˆæœ¬æ›´æ–°å®Œæˆ!"
print_message $BLUE "ğŸ“‹ ç‰ˆæœ¬: $CURRENT_VERSION â†’ $NEW_VERSION"
print_message $BLUE "ğŸ·ï¸  æ ‡ç­¾: v$NEW_VERSION"
print_message $YELLOW "ğŸ¤– GitHub Actionså°†è‡ªåŠ¨å‘å¸ƒåˆ°npm..."
print_message $BLUE "ğŸ”— æŸ¥çœ‹å‘å¸ƒè¿›åº¦: https://github.com/hahaha-zsq/dadandiaoming-cli/actions"

# å¯é€‰: æ‰“å¼€æµè§ˆå™¨æŸ¥çœ‹Actions
if command -v open > /dev/null 2>&1; then
    read -p "æ˜¯å¦æ‰“å¼€æµè§ˆå™¨æŸ¥çœ‹GitHub Actions? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        open "https://github.com/hahaha-zsq/dadandiaoming-cli/actions"
    fi
fi 